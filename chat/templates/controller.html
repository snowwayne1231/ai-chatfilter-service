<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Admin Chat Controller</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        div {
            box-sizing: border-box;
        }
        ul {
            list-style: none;
            padding: 0px 10px;
        }
        h1,h2,h3,p,ul {
            margin: 0px;
        }

        .main-ctl {
            padding: 0px;
            margin: 0px;
            overflow: hidden;
            height: 96vh;
            width: 100%;
            position: relative;
        }
        .float-l {
            float: left;
            height: 100%;
        }
        .left-panel {
            width: 200px;
            background-color: #e7e7e7;
            font-size: 20px;
        }
        
        .right-zone {
            width: 100%;
            height: 100%;
            display: block;
            padding-left: 200px;
        }
        .header {
            height: 100px;
            max-height: 20vh;
            font-size: 24px;
            width: 100%;
            background-color: #d1fff0;
            padding: 5px 20px;
            border-bottom: 1px solid #000;
        }
        .header label {
            font-size: 16px;
        }
        .content {
            height: calc(100% - 100px);
            overflow-y: auto;
            position: relative;
        }

        #pinyin-block-list {
            position: relative;
            height: 86%;
            overflow: auto;
            max-height: 80vh;
            box-sizing: border-box;
        }

        #pinyin-block-list >li {
            border-bottom: 1px solid #ccc;
            line-height: 32px;
        }
        #pinyin-block-list >li:nth-child(odd) {
            background-color: #f6fffc;
        }
        #pinyin-block-list >li:hover {
            background-color: #ededed;
        }

        #pinyin-block-list >li:hover .delete-sapn {
            visibility: inherit;
        }
        #pinyin-block-list.draging {
            border: 1px solid #21c2ff;
        }

        .pbz-btn {
            width: 80px;
            height: 32px;
            font-size: 20px;
            vertical-align: bottom;
            margin-right: 24px;
            cursor: pointer;
        }

        #pinyin-block-input {
            height: 34px;
            width: 280px;
        }
        .delete-sapn {
            color: red;
            cursor: pointer;
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            border: 1px solid red;
            border-radius: 50%;
            line-height: 20px;
            margin: 0px 4px;
            visibility: hidden;
        }
        .delete-sapn:hover {
            background-color: red;
            color: white;
        }
        .txt-span {
            display: inline-block;
            min-width: 320px;
        }
        .absolute-right {
            position: absolute;
            right: 0px;
            top: 0px;
        }
        .font-btn {
            font-size: 24px;
            margin: 5px;
            cursor: pointer;
        }
    </style>

    <style>
        .range {
            float: left;
            position: relative;
            margin: 0px 1%;
            max-height: 54vh;
            overflow: auto;
            box-sizing: border-box;
        }

        .range textarea, .range input {
            max-width: 100%;
            box-sizing: border-box;
        }

        .range textarea {
            min-height: 112px;
            max-height: 160px;
            line-height: 22px;
            width: 80%;
        }

        .bottom.range {
            height: 26vh;
            width: 100%;
            margin: 0px;
            padding: 2px 20px;
            border-top: 1px solid #000;
        }
        .left.range {
            width: 0%;
        }
        .right.range {
            height: 54vh;
            width: 98%;
        }
        table {
            width: 100%;
        }

        table td {
            min-width: 5%;
            border: 1px solid #666;
        }

        .prediction {
            text-align: center;
        }

        table dl {
            margin: 0px;
        }

        input[type=checkbox] {
            width: 16px;
            height: 16px;
        }

        .filter-btn {
            line-height: 22px;
        }

        .filter-btn dd {
            display: inline-block;
            /* border: 1px solid #333; */
        }
    </style>

    <style>
        .upload-zone {
            box-sizing: border-box;
            color: #fff;
            background-color: #ccc;
            border: 1px dashed #303030;
            width: 80%;
            min-height: 120px;
            line-height: 112px;
            font-size: 24px;
            margin: 12px auto;
            padding: 2px;
            text-align: center;
        }
        .upload-zone.draging {
            color: #28cd97;
            background-color: #ededed;
            border: 1px solid #1518d5; 
        }
    </style>
</head>
<body>
    <div class="main-ctl">
        <div class="float-l left-panel">
            <ul>
                <li><a href="#" onclick="naviTo('live-chat-zone');" title="ç§»å‹•åˆ°[å³æ™‚èŠå¤©]é ">å³æ™‚èŠå¤©</a></li>
                <li><a href="#" onclick="naviTo('pinyin-block-zone');" title="ç§»å‹•åˆ°[å³æ™‚ç¦è©]é ">å³æ™‚ç¦è©(æ‹¼éŸ³)</a></li>
                <!-- <li><a href="#" onclick="naviTo('train-center-zone');" title="ç§»å‹•åˆ°[è¨“ç·´è³‡æ–™ä¸­å¿ƒ]é ">è¨“ç·´è³‡æ–™ä¸­å¿ƒ</a></li> -->
            </ul>
        </div>
        <div class="right-zone">
            <div id="pinyin-block-zone" style="height: 100%; display: none;">
                <div class="header">
                    <h2>å³æ™‚ç¦è©(æ‹¼éŸ³)</h2>
                    <div>
                        <input type="text" id="pinyin-block-input"/>
                        <button class="pbz-btn" id="btn-local-search" title="æ¨¡ç³ŠåŒ¹é…æœå°‹å·²å­˜ç¦è©">æœå°‹</button>
                        <button class="pbz-btn" id="btn-add-block" title="æ–°å¢ç¦è©">æ–°å¢</button>
                    </div>
                    <div class="absolute-right">
                        <button class="font-btn" id="btn-download-list" title="ä¸‹è¼‰ç¾æœ‰ç¦è©">â¬</button>
                        <button class="font-btn" id="btn-refresh" title="åˆ·æ–°å¾Œå°ç¦è©åˆ° Tcp Socket æœå‹™">ğŸ”„</button>
                    </div>
                </div>
                <div class="content">
                    <ul id="pinyin-block-list">
                        <li></li>
                    </ul>
                    <div id="list-info"></div>
                </div>
            </div>
            <div id="live-chat-zone" style="height: 100%; display: block;">
                <div class="header">
                    <h2>å³æ™‚èŠå¤©</h2>
                    <div class="filter-btn">
                        <dd>
                            <label>è‡ªå®šç¾©æˆ¿è™Ÿ</label>
                            <input type="test" id="room-text" value="localhost_test"></input>
                        </dd>
                        <dd>
                            <label>åç¨±</label>
                            <input type="test" id="room-nickname" value="TST-test"></input>
                        </dd>
                        <dd>
                            <label>åªé¡¯ç¤ºåˆªé™¤</label>
                            <input type="checkbox" id="checkbox-show-delete"></input>
                        </dd>
                    </div>
                    <div class="filter-btn">
                        
                    </div>
                </div>
                <!-- <div class="left range">
                </div> -->
                <div class="right range">
                    
                    <table>
                        <thead>
                            <th style="width: 10%;">æˆ¿è™Ÿ</th>
                            <th style="width: 10%;">ç©å®¶</th>
                            <th style="width: 30%;">èŠå¤©å…§å®¹</th>
                            <th style="width: 5%;">çµæœ</th>
                            <th style="width: 15%;">åŸå› </th>
                            <th style="width: 30%;">è©³ç´°</th>
                        </thead>
                        <tbody id="table-body">
            
                        </tbody>
                    </table>
                </div>
                <div class="bottom range">
                    <textarea id="chat-log" cols="100" rows="20" readonly></textarea>
                    <input id="chat-message-input" type="text" size="100"/>
                    <input id="chat-message-submit" type="button" value="Send"/>
                </div>
            </div>
            <div id="train-center-zone" style="height: 100%; display: none;">
                <div class="header">
                    <h2>è¨“ç·´è³‡æ–™ä¸­å¿ƒ</h2>
                </div>
                <div class="right range">
                    <div id="upload-train-excel" class="upload-zone">è«‹æ‹–æ›³è¨“ç·´è³‡æ–™åˆ°æ­¤è™•</div>
                </div>
            </div>
        </div>
    </div>

    <script id="common">
        var key_send_train_remotely = '__remotetrain__';
        var key_get_model = '__getmodel__';
        var key_is_admin_client = '__isadminclient__';

        var maxSocketRetry = 15;
        window.conn = ConnWebSocket();
        
        function ConnWebSocket(name='') {
            if (window.conn) {
                delete window.conn.onmessage
                delete window.conn.onclose
                delete window.conn.onerror
                delete window.conn
            }

            var chatSocket = new WebSocket(
                // 'ws://' + window.location.host + '/ws/chat/' + name + '/'
                'ws://' + window.location.host + '/ws/chat/'
            );

            var _limit_chatbox = 100;

            chatSocket.onopen = function() {
                chatSocket.send(JSON.stringify({
                    'msgid': key_is_admin_client,
                }));
            }

            chatSocket.onmessage = function(e) {
                var data = JSON.parse(e.data);
                var msgid = data['msgid'];
                var user = data['user'];
                var room = data['room'];
                var message = data['message'];
                var prediction = data['prediction'];
                var reason_char = data['reason_char'];
                var detail = data['detail'];

                if (Number.isInteger(msgid)) {

                    if (window.is_show_only_deleted && prediction == 0) {
                        return;
                    }
                    
                    var tbody = document.querySelector('#table-body');
                    var _tr = document.createElement('tr');
                    ['room', 'user', 'message', 'prediction', 'reason_char', 'detail'].map(e => {
                        var loc = data[e];
                        var _td = document.createElement('td');
                            
                        if (typeof loc == 'object') {
                            // console.log(loc);
                            // loc = JSON.stringify(loc);
                            handleObjectToTd(_td, loc)
                            
                        } else {
                            _td.innerText = loc;
                        }
                        _td.className = e;
                        _tr.appendChild(_td);
                    });
                    tbody.prepend(_tr);
                    
                    var trs = tbody.getElementsByTagName('tr');
                    // console.log('trs: ', [trs]);
                    if (trs.length > _limit_chatbox) {
                        tbody.removeChild(tbody.lastChild)
                    }
                }
                
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
                reConnectWebSocket()
            };

            chatSocket.onerror = function(e) {
                reConnectWebSocket()
            }

            return chatSocket;
        }

        function reConnectWebSocket() {
            if (window.connectedTimer) {
                window.clearTimeout(window.connectedTimer);
                delete window.connectedTimer;
            }

            window.connectedTimer = window.setTimeout(connection, 5000);
        }

        var conn_i = 0;
        function connection() {
            if (conn_i++ >= maxSocketRetry) {
                window.alert('Please Reload This Page, The Socket Connection Can Not Be Connected.');
            } else {
                window.conn = ConnWebSocket();
            }
        }
        function naviTo(zoneName) {
            var zones = [
                'live-chat-zone',
                'pinyin-block-zone',
            ];
            var _dom = document.getElementById(zoneName);
            if (_dom) {
                zones.map(z => {
                    document.getElementById(z).style.display='none';
                });
                _dom.style.display='block';
            } else {
                zones.map((z, idx) => {
                    document.getElementById(z).style.display= idx == 0 ? 'block' : 'none';
                });
            }
        }
    </script>
    
    <script id="pinyin-block-script">
        var pinyin_block_list = document.querySelector('#pinyin-block-list');
        var pinyin_block_input = document.querySelector('#pinyin-block-input');
        var list_info = document.querySelector('#list-info');
        var btn_add_block = document.querySelector('#btn-add-block');
        var btn_local_search = document.querySelector('#btn-local-search');
        var btn_download_list = document.querySelector('#btn-download-list');
        var btn_refresh = document.querySelector('#btn-refresh');
        var global_pinyin_block_list = [];
        var goon = false;
        var max_block_num = 255;
        // console.log('axios', axios);

        reloadPinyinList();
        
        btn_add_block.onclick = function(e) {
            var val = pinyin_block_input.value;
            addPinyin(val.trim());
        }

        btn_local_search.onclick = function(e) {
            var val = pinyin_block_input.value;
            var exp = RegExp(`.*${val}.*`, 'ig');
            if (val.length == 0) {
                showList(global_pinyin_block_list);
            } else {
                showList(global_pinyin_block_list.filter(e => e[1].match(exp) || e[2].match(exp)));
            }
            // console.log('global_pinyin_block_list: ', global_pinyin_block_list);
        }

        pinyin_block_input.onchange = function(e) {
            if (e.target.value.length == 0) {
                showList(global_pinyin_block_list);
            }
        }

        pinyin_block_list.onclick = function(e) {
            var target = e.target;
            if (target.classList.contains("delete-sapn")) {
                if (!goon) {
                    goon = window.confirm('ç¢ºå®šåŸ·è¡Œåˆªé™¤?');
                }
                if (goon) {
                    var id = target.dataset.id;
                    console.log([target]);

                    axios.delete('/api/pinyinblock/' + id).then(e => {
                        console.log('delete api: ', e.data);
                        var _idx = global_pinyin_block_list.findIndex(e => e[0] == id);
                        global_pinyin_block_list.splice(_idx, 1);
                        list_info.innerHTML = `Total Length: ${global_pinyin_block_list.length}`;
                        pinyin_block_list.removeChild(target.parentNode);
                    });
                }
            }
        }

        pinyin_block_list.ondragenter = pinyin_block_list.ondragover = function(e) {
            e.preventDefault();
            this.classList.add('draging');
        }
        pinyin_block_list.ondragleave = function(e) {
            e.preventDefault();
            this.classList.remove('draging');
        }

        pinyin_block_list.ondrop = function(e) {
            e.preventDefault();
            this.classList.remove('draging');
            var file = e.dataTransfer.files[0];
            
            
            if (file.name.match(/.*\.csv$/i)) {
                // var formData = new FormData();
                // formData.append('file', file);
                // console.log('formData: ', formData);
                // axios.post('/api/upload/', formData, {
                //     headers: {
                //         'Content-Type': file.type,
                //         'Content-Disposition': 'attachment; filename=' + file.name,
                //     }
                // });
                const reader = new FileReader();
                reader.onload = function (event) {
                    console.log(event.target); 
                    var res_text = event.target.result;
                    var res_ary = res_text.split(/[\r\n]+/ig).map(r => r.split(',')[1]).filter(r => r && r.length > 0);
                    console.log('reader res_ary: ', res_ary);
                    var global_list = global_pinyin_block_list.map(e => e[1]);
                    var filtered_ary = res_ary.filter(r => {
                        return !global_list.includes(r);
                    });
                    console.log('filtered_ary: ', filtered_ary);
                    addPinyin(filtered_ary);
                };
                reader.readAsText(file);
            } else {
                window.alert('éŒ¯èª¤çš„æª”æ¡ˆæ ¼å¼');
            }
        }

        btn_download_list.onclick = function(e) {
            window.open('/api/pinyinblock/list', 'blank');
        }

        btn_refresh.onclick = function (e) {
            if (window.conn) {
                window.conn.send(JSON.stringify({
                    'msgid': '__tcpsocketrefreshpinyinblock__',
                    'code': 1,
                }));
                window.alert('å·²æ›´æ–°ç¦è©');
                // axios.post('/api/pinyinblock/refresh').then(e => {
                    
                // });
            } else {
                window.alert('è«‹ç­‰å¾…socketé€£ç·š.');
            }
            
        }


        function showList(block_list) {
            var new_html = '';
            goon = false;
            block_list.slice(0, 100).map(ary => {
                var id = ary[0];
                var txt = ary[1];
                var py = ary[2];
                new_html += strLi(id, txt, py);
            });
            if (block_list.length >= 100) {
                new_html += 'æœ€å¤šåªé¡¯ç¤º100ç­†..';
            }
            pinyin_block_list.innerHTML = new_html;
            list_info.innerHTML = `Now Length: ( ${block_list.length} ) / Total Length: ${global_pinyin_block_list.length}`;
        }

        function reloadPinyinList() {
            axios.get('/api/data/dpinyinblist').then(e => {
                global_pinyin_block_list = e.data;
                console.log('global_pinyin_block_list: ', global_pinyin_block_list);
                goon = false;
                if (e.data.length == 0) {
                    pinyin_block_list.innerHTML = 'ç„¡è³‡æ–™';
                } else {
                    showList(global_pinyin_block_list);
                }
            });
        }

        function strLi(id, txt, py){
            var _html = `<li><span class="delete-sapn" data-id="${id}">X</span><span class="txt-span">${txt}</span> <span>| ${py}</span></li>`;
            return _html;
        }

        function domLi(id, txt, py) {
            var _dom = document.createElement('li');
            _dom.innerHTML = `<span class="delete-sapn" data-id="${id}">X</span><span class="txt-span">${txt}</span> <span>| ${py}</span>`;
            return _dom;
        }

        function addPinyin(text) {
            if (!text) return false;
            if (global_pinyin_block_list.length >= max_block_num) {
                return window.alert(`æœ€å¤šåªèƒ½ç¦ [ ${max_block_num} ] å€‹ç¦è©. `);
            }
            goon = false;

            var formData = new FormData();

            if (Array.isArray(text)) {
                if (text.length > 0) {
                    if (global_pinyin_block_list.length + text.length > max_block_num) {
                        return window.alert(`æœ€å¤šåªèƒ½ç¦ [ ${max_block_num} ] å€‹ç¦è©. `);
                    }
                    text.map(t => {
                        formData.append('text[]', t);
                    });
                } else {
                    return window.alert('æ²’æœ‰éœ€è¦æ›´æ–°.');
                }
            } else {
                var isConflict = false;
                global_pinyin_block_list.map(e => {
                    var _txt = e[0];
                    if (text == _txt) {
                        isConflict = true;
                    }
                });
                if (isConflict) {
                    return window.alert('é‡è¤‡æ–°å¢: '+ text);
                }
                if (text.match(/[\d]+/g)) {
                    return window.alert('ä¸èƒ½æœ‰æ•¸å­—');
                }
                formData.append('text[]', text);
            }
            
            return axios.post('/api/pinyinblock/add', formData).then(e => {
                var data = e.data;
                var result = data.result;
                if (result) {
                    if (result.length == 1) {
                        result.map(r => {
                            var id = r.id;
                            var text = r.text;
                            var pinyin = r.pinyin;
                            console.log('pinyinblock data: ', data);
                            pinyin_block_list.prepend(domLi(id, text, pinyin));
                            pinyin_block_input.value = '';
                            global_pinyin_block_list.unshift([id, text, pinyin]);
                            list_info.innerHTML = `Total Length: ${global_pinyin_block_list.length}`;
                        });
                    } else {
                        reloadPinyinList();
                    }
                    window.alert('æ–°å¢æˆåŠŸ.');
                } else {
                    window.alert('æ–°å¢å¤±æ•—.');
                    console.log('text: ', text, 'data: ', data);
                    reloadPinyinList();
                }
            });
        }
    </script>

    <script id="chat-script">
        // var roomName = {{ room_name_json }};
        var randomUsers = new Array(3).fill(0).map(e => {
            return Math.random().toString(16).substring(2,8);
        });
        var randomRooms = new Array(5).fill(0).map(e => {
            return Math.random().toString(16).substring(2,6);
        });

        // window.conn = ConnWebSocket();

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };
        document.querySelector('#chat-message-submit').onclick = function(e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.value;
            if (window.conn) {
                window.conn.send(JSON.stringify({
                    'msgid': 1234,
                    'user': (document.querySelector('#room-nickname').value || '').trim(),
                    // 'room': randomRooms[Math.floor(Math.random() * randomRooms.length)],
                    'room': (document.querySelector('#room-text').value || '').trim(),
                    'message': message.replace(/\Â /g, ''),
                    'detail': 1,
                }));
                messageInputDom.value = '';

                document.querySelector('#chat-log').value += (message + '\n');
            }
        };

        document.querySelector('#checkbox-show-delete').onclick = function(e) {
            var checked = this.checked;
            window.is_show_only_deleted = checked;
        }

        function handleObjectToTd(ele, _object) {
            for (key in _object) {
                var _val = _object[key];
                var __div = document.createElement('div');
                if (typeof _val == 'object' && !Array.isArray(_val)) {
                    handleObjectToTd(__div, _val)
                } else {
                    if (key == 'predicted_ratios') {
                        var __next_val = '';
                        _val.map((v,i) => {
                            if (parseInt(v) > 0) {
                                __next_val += '<i>[ ' + i + ' ] = ' + v + '</i><br/>';
                            }
                        });
                        
                        _val = __next_val
                    }
                    __div.innerHTML = '<dl>'+key+' : </dl><dl>' + _val + '</dl>';
                }
                ele.appendChild(__div);
            }
        }

    </script>

    <script id="train-script">
        var dom_upload_zones = document.querySelectorAll('.upload-zone');
        var dom_upload_train_excel = document.getElementById('upload-train-excel');
        
        console.log('dom_upload_zones: ', dom_upload_zones);

        dom_upload_zones.forEach(d => {
            d.addEventListener('dragover', function(e){
                e.preventDefault();
                this.classList.add('draging');
            });
            d.addEventListener('drop', function(e){
                e.preventDefault();
                this.classList.remove('draging');
            });
            d.addEventListener('dragleave', function(e){
                e.preventDefault();
                this.classList.remove('draging');
            });
        });

        dom_upload_train_excel.addEventListener('drop', function(e){
            var file = e.dataTransfer.files[0];
            console.log('file: ', file)
            if (file.name.match(/.*\.xls.$/i)) {
                var formData = new FormData();
                formData.append('file', file);
                console.log('formData: ', formData);
                axios.post('/api/upload/', formData, {
                    headers: {
                        'Content-Type': file.type,
                        'Content-Disposition': 'attachment; filename=' + file.name,
                    }
                });
                // const reader = new FileReader();
                // reader.onload = function (event) {
                //     console.log(event.target); 
                //     var res_text = event.target.result;
                //     var res_ary = res_text.split(/[\r\n]+/ig).map(r => r.split(',')[1]).filter(r => r && r.length > 0);
                    
                // };
                // reader.readAsText(file);
            } else {
                window.alert('éŒ¯èª¤çš„æª”æ¡ˆæ ¼å¼');
            }
        });

            

        

        
    </script>
</body>
</html>